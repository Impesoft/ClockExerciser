<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:sfRadialGauge="clr-namespace:Syncfusion.Maui.Gauges;assembly=Syncfusion.Maui.Gauges"
             xmlns:converters="clr-namespace:ClockExerciser.Converters"
             x:Class="ClockExerciser.GamePage"
             Title="{Binding AppTitle}">
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>
    <ScrollView>
        <VerticalStackLayout Padding="24" Spacing="18">

            <!-- Mode Switcher (horizontal buttons for quick mode change during game) -->
            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8" IsVisible="{Binding IsGameOver, Converter={StaticResource InvertedBoolConverter}}">
                <Button Grid.Column="0" 
                        Text="ðŸ•â†’â°" 
                        FontSize="12"
                        Padding="4,8"
                        Command="{Binding SwitchToClockToTimeCommand}"
                        BackgroundColor="{AppThemeBinding Light=#2196F3, Dark=#1976D2}"
                        TextColor="White" />
                <Button Grid.Column="1" 
                        Text="â°â†’ðŸ•" 
                        FontSize="12"
                        Padding="4,8"
                        Command="{Binding SwitchToTimeToClockCommand}"
                        BackgroundColor="{AppThemeBinding Light=#4CAF50, Dark=#388E3C}"
                        TextColor="White" />
                <Button Grid.Column="2" 
                        Text="ðŸŽ²" 
                        FontSize="12"
                        Padding="4,8"
                        Command="{Binding SwitchToRandomModeCommand}"
                        BackgroundColor="{AppThemeBinding Light=#FF9800, Dark=#F57C00}"
                        TextColor="White" />
            </Grid>

            <Label Text="{Binding InstructionText}" />

            <Border Padding="-20" BackgroundColor="{AppThemeBinding Light=#f5f5f5, Dark=#1f1f1f}" HorizontalOptions="Center">
                <Border.StrokeShape>
                    <Ellipse />
                </Border.StrokeShape>
                <sfRadialGauge:SfRadialGauge HeightRequest="250" WidthRequest="250">
                    <sfRadialGauge:SfRadialGauge.Axes>
                        <sfRadialGauge:RadialAxis Minimum="0"
                                                  Maximum="12"
                                                  Interval="1"
                                                  MinorTicksPerInterval="4"
                                                  StartAngle="270"
                                                  EndAngle="270"
                                                  ShowLabels="True"
                                                  ShowAxisLine="False"
                                                  ShowLastLabel="False"
                                                  LabelCreated="HourAxis_LabelCreated">
                            <sfRadialGauge:RadialAxis.Pointers>
                                <sfRadialGauge:NeedlePointer Value="{Binding SecondPointerValue}"
                                                             NeedleLengthUnit="Factor"
                                                             NeedleLength="1"
                                                             NeedleStartWidth="1"
                                                             NeedleEndWidth="1"
                                                             KnobSizeUnit="Factor"
                                                             KnobRadius="0.05"
                                                             NeedleFill="#d84315" />
                                <sfRadialGauge:NeedlePointer Value="{Binding MinutePointerValue}"
                                                             NeedleLengthUnit="Factor"
                                                             NeedleLength="0.90"
                                                             NeedleStartWidth="5"
                                                             NeedleEndWidth="5"
                                                             KnobSizeUnit="Factor"
                                                             KnobRadius="0.08"
                                                             NeedleFill="{AppThemeBinding Light=#002200, Dark=#002200}" />
                                <sfRadialGauge:NeedlePointer Value="{Binding MinutePointerValue}"
                                                             NeedleLengthUnit="Factor"
                                                             NeedleLength="0.90"
                                                             NeedleStartWidth="4"
                                                             NeedleEndWidth="4"
                                                             KnobSizeUnit="Factor"
                                                             KnobRadius="0.08"
                                                             NeedleFill="{AppThemeBinding Light=#4CAF50, Dark=#81C784}" />
                                <sfRadialGauge:NeedlePointer Value="{Binding HourPointerValue}"
                                                             NeedleLengthUnit="Factor"
                                                             NeedleLength="0.60"
                                                             NeedleStartWidth="5"
                                                             NeedleEndWidth="5"
                                                             KnobSizeUnit="Factor"
                                                             KnobRadius="0.08"
                                                             TailLength="0.05"
                                                             TailLengthUnit="Factor"
                                                             NeedleFill="{AppThemeBinding Light=#2196F3, Dark=#64B5F6}" />
                            </sfRadialGauge:RadialAxis.Pointers>
                        </sfRadialGauge:RadialAxis>
                    </sfRadialGauge:SfRadialGauge.Axes>
                </sfRadialGauge:SfRadialGauge>
            </Border>

            <VerticalStackLayout Spacing="4" IsVisible="{Binding IsTimeToClock}">
                <HorizontalStackLayout Spacing="8">
                    <Label Text="{Binding PromptLabel}" FontAttributes="Bold" VerticalOptions="Start"/>
                    <Label Text="{Binding PromptText}" VerticalOptions="Center"/>
                    <Label Text="{Binding PromptDigital}" FontAttributes="Bold" VerticalOptions="End"/>
                </HorizontalStackLayout>
            </VerticalStackLayout>

            <Entry Placeholder="{Binding EntryPlaceholder}"
                   IsVisible="{Binding IsClockToTime}"
                   Keyboard="Chat"
                   ClearButtonVisibility="WhileEditing"
                   Text="{Binding AnswerText, Mode=TwoWay}" />

            <VerticalStackLayout Spacing="8" IsVisible="{Binding IsTimeToClock}">
                <Label Text="{Binding HourLabel}" FontAttributes="Bold" />
                <Slider Minimum="-12"
                        Maximum="12"
                        Value="{Binding UserHourValue, Mode=TwoWay}"
                        MinimumTrackColor="{AppThemeBinding Light=#2196F3, Dark=#64B5F6}"
                        MaximumTrackColor="{AppThemeBinding Light=#BDBDBD, Dark=#757575}"
                        DragCompleted="HourSlider_DragCompleted" />
                <Label Text="{Binding MinuteLabel}" FontAttributes="Bold" />
                <Slider Minimum="-60"
                        Maximum="60"
                        Value="{Binding UserMinuteValue, Mode=TwoWay}"
                        MinimumTrackColor="{AppThemeBinding Light=#4CAF50, Dark=#81C784}"
                        MaximumTrackColor="{AppThemeBinding Light=#BDBDBD, Dark=#757575}"/>
            </VerticalStackLayout>

            <!-- Score Display -->
            <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,8,0,0">
                <!-- Current Score -->
                <Label Grid.Column="0" FontSize="20" FontAttributes="Bold" VerticalOptions="Center">
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="ðŸ† " FontFamily="{OnPlatform WinUI='Segoe UI Emoji'}" />
                            <Span Text="{Binding CorrectAnswers}" TextColor="#2e7d32" />
                        </FormattedString>
                    </Label.FormattedText>
                </Label>
                
                <!-- Wrong Answers -->
                <Label Grid.Column="1" FontSize="18" FontAttributes="Bold" HorizontalOptions="Center" VerticalOptions="Center">
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="âŒ " FontFamily="{OnPlatform WinUI='Segoe UI Emoji'}" />
                            <Span Text="{Binding WrongAnswers}" TextColor="#c62828" />
                            <Span Text="/" TextColor="#c62828" />
                            <Span Text="3" TextColor="#c62828" />
                        </FormattedString>
                    </Label.FormattedText>
                </Label>
                
                <!-- High Score -->
                <Label Grid.Column="2" FontSize="20" FontAttributes="Bold" VerticalOptions="Center">
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="â­ " FontFamily="{OnPlatform WinUI='Segoe UI Emoji'}" />
                            <Span Text="{Binding HighScore}" TextColor="#f57c00" />
                        </FormattedString>
                    </Label.FormattedText>
                </Label>
            </Grid>

            <!-- Single Primary Action Button -->
            <Button Text="{Binding PrimaryButtonText}"
                    Command="{Binding CheckAnswerCommand}"
                    IsEnabled="{Binding CanSubmit}"
                    HorizontalOptions="Fill"
                    IsVisible="{Binding IsGameOver, Converter={StaticResource InvertedBoolConverter}}" />
            
            <!-- New Game Button (shown when game is over) -->
            <Button Text="{Binding NewGameButtonText}"
                    Command="{Binding NewGameCommand}"
                    HorizontalOptions="Fill"
                    BackgroundColor="#2196F3"
                    IsVisible="{Binding IsGameOver}" />
            
            <Label Text="{Binding ResultMessage}"
                   IsVisible="{Binding ResultVisible}"
                   HorizontalTextAlignment="Center"
                   FontAttributes="Bold">
                <Label.Triggers>
                    <DataTrigger TargetType="Label"
                                Binding="{Binding ResultSuccess}"
                                Value="True">
                        <Setter Property="TextColor" Value="#2e7d32" />
                    </DataTrigger>
                    <DataTrigger TargetType="Label"
                                Binding="{Binding ResultSuccess}"
                                Value="False">
                        <Setter Property="TextColor" Value="#c62828" />
                    </DataTrigger>
                </Label.Triggers>
            </Label>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>